<div class="title">{{title}}</div>

<div class="float-right" id="adjust-height">
    <label class="clickable-label" onclick="adjustDivHeight(true)">▼</label>
    <label class="clickable-label" onclick="adjustDivHeight(false)">▲</label>
</div>

<div class="div-outside" id="div-outside">
    <div class="div-inside">
        <img id="image" class="covered-image" src="{{image}}"></img>
        <canvas id="canvas" class="covering-canvas"></canvas>
    </div>
</div>

{{#notes}}
<div><li onclick="showNotes(this)" class="show-notes-btn">⊙</li></div>
<div id="notes" style="display: none">{{notes}}</div>
{{/notes}}

<div id="tags" class="tags"></div>

<code class="invisible" id="original-mask">{{mask}}</code>
<code class="invisible" id="original-tags">{{Tags}}</code>

<script type="text/javascript">
    var cs = new CardStorageImageCloze()

    cs.build(takeContent('original-mask'))

    // show_result()
    show_tags(takeContent('original-tags'), 'tags', 'tag')

    if(is_mobile){
        window.onunload = function() {
            if (Persistence.isAvailable())
                Persistence.setItem(cs)
        }
    }else{
        document.getElementById('adjust-height').remove()
    }

    var canvas = document.getElementById('canvas')
    var image = document.getElementById('image')
    var divResizable = document.getElementById('div-outside')

    loadDivHeight(divResizable)

    if(undefined !== resizeObserver)
        resizeObserver.disconnect()

    var resizeObserver = new ResizeObserver(entries => {
        for(const entry of entries){
            if(entry.target == image){
                const r = entry.contentRect
                cs.imageWidth = r.width
                cs.imageHeight = r.height

                canvas.style.width = `${cs.imageWidth}px`
                canvas.style.height = `${cs.imageHeight}px`
                canvas.width = cs.imageWidth
                canvas.height = cs.imageHeight

                show_masks()
            }else if(entry.target == divResizable){
                saveDivHeight(entry.contentRect.height)
            }
        }
    })

    resizeObserver.observe(image)
    resizeObserver.observe(divResizable)

    canvas.onmousedown = (e) => {
        if(0 !== e.button) // left button only
            return

        const clientRect = canvas.getBoundingClientRect();
        const startClientX = e.clientX
        const startClientY = e.clientY

        const canvasX = startClientX - clientRect.left
        const canvasY = startClientY - clientRect.top

        const hitIndex = cs.hit(canvasX, canvasY)

        if(hitIndex>=0){
            showClozeAnswer(hitIndex,undefined)
            show_masks()
        }
    }

    function showNotes(li){
        document.getElementById('notes').style.display = 'block'
        li.remove()
    }

    if(undefined !== keyChecker)
        keyChecker.uninstall()

    var keyChecker= new EventHistoryTimer(['keydown'], 20)
    keyChecker.install(function(e){
        if(e.ctrlKey && e.altKey){
            let show
            let add
            if('1'==e.key)
                show = true
            else if('2'==e.key)
                show = false
            else if('3'==e.key)
                add = true
            else if('4'==e.key)
                add = false

            if(undefined !== show){
                showClozeAnswerByStep(show)
                return true
            }

            if(undefined !== add){
                adjustDivHeight(add)
                return true
            }
        }
        return false
    })
</script>