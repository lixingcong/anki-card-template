<div>{{title}}</div>

<div class="float-right" id="adjust-height">
    <button onclick="adjustDivHeight(true)">高度+</button>
    <button onclick="adjustDivHeight(false)">高度-</button>
</div>

<div class="div-outside" id="div-outside">
    <div class="div-inside">
        <img id="image" class="covered-image" src="{{image}}"></img>
        <canvas id="canvas" class="covering-canvas"></canvas>
    </div>
</div>

{{#notes}}
<div><li onclick="showNotes(this)" class="show-notes-btn">⊙</li></div>
<span id="notes" style="display: none">{{notes}}</span>
{{/notes}}

<div id="tags" class="tags"></div>

<code class="invisible" id="original-mask">{{mask}}</code>
<code class="invisible" id="original-tags">{{Tags}}</code>

<script type="text/javascript">
    var cs = new CardStorageImageCloze()

    cs.build(takeContent('original-mask'))

    // show_result()
    show_tags(takeContent('original-tags'), 'tags', 'tag')

    if(is_mobile){
        window.onunload = function() {
            if (Persistence.isAvailable())
                Persistence.setItem(cs)
        }
    }else{
        document.getElementById('adjust-height').remove()
    }

    var canvas = document.getElementById('canvas')
    var image = document.getElementById('image')
    var divResizable = document.getElementById('div-outside')

    var divHeight = Persistence.getItem(StoreKeyDivHeight)
    if(undefined == divHeight)
        divResizable.style.height =  (window.innerHeight * 0.8) + 'px'
    else
        divResizable.style.height = divHeight

    if(undefined !== resizeObserver)
        resizeObserver.unobserve(image)

    var resizeObserver = new ResizeObserver(entries => {
        const first = entries[0].contentRect
        cs.imageWidth = first.width
        cs.imageHeight = first.height

        canvas.style.width = cs.imageWidth + 'px'
        canvas.style.height = cs.imageHeight + 'px'
        canvas.width = cs.imageWidth
        canvas.height = cs.imageHeight

        show_masks()

        if (Persistence.isAvailable())
            Persistence.setItem(StoreKeyDivHeight, divResizable.style.height)
    })

    resizeObserver.observe(image)

    canvas.onmousedown = (e) => {
        const clientRect = canvas.getBoundingClientRect();
        const startClientX = e.clientX
        const startClientY = e.clientY

        const canvasX = startClientX - clientRect.left
        const canvasY = startClientY - clientRect.top

        const hitIndex = cs.hit(canvasX, canvasY)

        if(hitIndex>=0){
            showClozeAnswer(hitIndex,undefined)
            show_masks()
        }
    }

    function showNotes(li){
        document.getElementById('notes').style.display = 'block'
        li.remove()
    }

    if(undefined !== keyChecker)
        keyChecker.uninstall()

    var keyChecker= new EventHistoryTimer('keydown', 60)
    keyChecker.install(function(e){
        if(e.ctrlKey && e.altKey){
            let show
            if(49==e.keyCode)
                show = true
            else if(50==e.keyCode)
                show = false

            if(undefined !== show){
                showClozeAnswerByStep(show)
                return true
            }
        }
        return false
    })
</script>